<html>
  <head>
    <script type="text/javascript" src="../src/dialog/dialog-comm.js"></script>
    <style>
      .error {
        border: 1px solid red;
      }
      .messageColor {
        color: rgb(255,0,0);
      }
      .hideMessage {
        display: none;
      }
    </style>
    <script type="text/javascript">
      (function(){

        function addClass( elem, name ) {
          if( elem.className.search(name) === -1 ) {
            elem.className += " " + name;
          }
        }

        function removeClass( elem, className ) {
          elem.className = elem.className.replace( className, "" );
        }

        var _comm = new Comm(),
            _counter = 0,
            _manifest = {},
            _popcornOptions = {};

        function setError( data ) {
          var elem = document.getElementById( data.field + "-error" );
          elem.innerHTML = data.message;
          removeClass( elem, "hideMessage" );
          addClass( document.getElementById( data.field ), "error" );
        }
        
        function validate() {
          var ok = true;
          if( isNaN(_popcornOptions.start) ) {
            var message = "Start must be a number";
            _comm.send( "error", {
              message: message
            });
            setError({
              message: message,
              field: "start"
            });
            ok = false;
          } else {
            addClass( document.getElementById( "start-error" ), "hideMessage" );
            removeClass( document.getElementById( "start" ), "error" );
          }
          if( isNaN(_popcornOptions.end) ) {
            var message = "End must be a number";
            _comm.send( "error", {
              message: message
            });
            setError({
              message: message,
              field: "end"
            });
            ok = false;
          } else {
            addClass( document.getElementById( "end-error" ), "hideMessage" );
            removeClass( document.getElementById( "end" ), "error" );
          }

          return ok;
        }

        document.addEventListener( "DOMContentLoaded", function( e ){
          var okButton = document.getElementById( "ok" ),
              cancelButton = document.getElementById( "cancel" );

          okButton.addEventListener( "click", function( e ){
            
            for( var item in _manifest ) {
              _popcornOptions[ item ] = document.getElementById( item ).value;
            }
            
            if( validate() ) {
              _comm.send( "submit", _popcornOptions );
              _comm.send( "close" );
            }
          }, false );

          cancelButton.addEventListener( "click", function( e ){
            _comm.send( "cancel" );
          }, false );

          _comm.listen( "trackeventdata", function( e ) {
            var _popcornOptions = e.data.popcornOptions,
                targets = e.data.targets,
                medias = e.data.medias;

            _manifest = e.data.manifest.options;

            for( var item in _manifest ) {
              var row = document.createElement( "TR" ),
                  col1 = document.createElement( "TD" ),
                  col2 = document.createElement( "TD" ),
                  elem = _manifest[ item ].elem;

                  col1.innerHTML = "<b>" + (!_manifest[ item ].label ? item : _manifest[ item ].label) + "</b>";

                  if( item === "target" ) {
                    var select = document.createElement( "SELECT" );
                    select.id = "target";

                    for( var i = 0, l = targets.length; i < l; i++ ) {
                      var option = document.createElement( "OPTION" );
                      option.value = targets[ i ];
                      option.innerHTML = targets[ i ];
                      select.appendChild( option );
                      if( _popcornOptions.target === targets[ i ] ) {
                        select.value = targets[ i ];
                      }
                    }
                    var option = document.createElement( "OPTION" );
                    option.value = "Media Element";
                    option.innerHTML =  "Media Element";
                    select.appendChild( option );
                    if( _popcornOptions.target === "Media Element" ) {
                        select.value = "Media Element";
                    }
                    col2.appendChild( select );
                  } else {
                    col2.innerHTML = "<" + elem + " id='" + item + 
                    "' style='width:100%' value='" + _popcornOptions[ item ] + "'></" + elem + ">";
                    col2.innerHTML += "</br><div id='" + item + "-error' class='hideMessage messageColor'></div>";
                  }

                  row.appendChild( col1 );
                  row.appendChild( col2 );
                  document.getElementById( "table" ).appendChild( row );
            }
          });
        }, false );
      })();
    </script>
  </head>
  <body>
    <table id="table">
    </table>
    <button id="ok">Ok</button>
    <button id="cancel">Cancel</button>
  </body>
</html>
